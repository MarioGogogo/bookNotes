<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 性能优化大挑战 | 👨🏽‍💻前端漫游指南</title>
    <meta name="description" content="Never Stop Learning">
    <link rel="icon" href="/bookNotes/favicon.ico">
    
    <link rel="preload" href="/bookNotes/assets/css/0.styles.02a9e5b3.css" as="style"><link rel="preload" href="/bookNotes/assets/js/app.a5c1f5ee.js" as="script"><link rel="preload" href="/bookNotes/assets/js/73.2a333618.js" as="script"><link rel="prefetch" href="/bookNotes/assets/js/10.7897844d.js"><link rel="prefetch" href="/bookNotes/assets/js/11.daa46aa2.js"><link rel="prefetch" href="/bookNotes/assets/js/12.19efc583.js"><link rel="prefetch" href="/bookNotes/assets/js/13.5b7f839d.js"><link rel="prefetch" href="/bookNotes/assets/js/14.47b4842d.js"><link rel="prefetch" href="/bookNotes/assets/js/15.959aa0c7.js"><link rel="prefetch" href="/bookNotes/assets/js/16.e07efd9a.js"><link rel="prefetch" href="/bookNotes/assets/js/17.06df2fb1.js"><link rel="prefetch" href="/bookNotes/assets/js/18.40dee455.js"><link rel="prefetch" href="/bookNotes/assets/js/19.ea09a6c5.js"><link rel="prefetch" href="/bookNotes/assets/js/2.2daf200c.js"><link rel="prefetch" href="/bookNotes/assets/js/20.ffb27053.js"><link rel="prefetch" href="/bookNotes/assets/js/21.33f73e1d.js"><link rel="prefetch" href="/bookNotes/assets/js/22.9e99b0e5.js"><link rel="prefetch" href="/bookNotes/assets/js/23.5417826f.js"><link rel="prefetch" href="/bookNotes/assets/js/24.59000dfc.js"><link rel="prefetch" href="/bookNotes/assets/js/25.acc91333.js"><link rel="prefetch" href="/bookNotes/assets/js/26.6af21f36.js"><link rel="prefetch" href="/bookNotes/assets/js/27.3d2e96f4.js"><link rel="prefetch" href="/bookNotes/assets/js/28.262d38c6.js"><link rel="prefetch" href="/bookNotes/assets/js/29.1eca77c6.js"><link rel="prefetch" href="/bookNotes/assets/js/3.2e998a1c.js"><link rel="prefetch" href="/bookNotes/assets/js/30.af641b29.js"><link rel="prefetch" href="/bookNotes/assets/js/31.3c9c863c.js"><link rel="prefetch" href="/bookNotes/assets/js/32.07ea838c.js"><link rel="prefetch" href="/bookNotes/assets/js/33.acab53c4.js"><link rel="prefetch" href="/bookNotes/assets/js/34.48dd7240.js"><link rel="prefetch" href="/bookNotes/assets/js/35.7c3ec624.js"><link rel="prefetch" href="/bookNotes/assets/js/36.ccd745ec.js"><link rel="prefetch" href="/bookNotes/assets/js/37.005d8f1b.js"><link rel="prefetch" href="/bookNotes/assets/js/38.fc6a5f21.js"><link rel="prefetch" href="/bookNotes/assets/js/39.44489367.js"><link rel="prefetch" href="/bookNotes/assets/js/4.dd5fac1d.js"><link rel="prefetch" href="/bookNotes/assets/js/40.34c225a3.js"><link rel="prefetch" href="/bookNotes/assets/js/41.1e7d641f.js"><link rel="prefetch" href="/bookNotes/assets/js/42.236029dd.js"><link rel="prefetch" href="/bookNotes/assets/js/43.09a1cad0.js"><link rel="prefetch" href="/bookNotes/assets/js/44.8165a802.js"><link rel="prefetch" href="/bookNotes/assets/js/45.01f5f11f.js"><link rel="prefetch" href="/bookNotes/assets/js/46.46b782a7.js"><link rel="prefetch" href="/bookNotes/assets/js/47.1ec61019.js"><link rel="prefetch" href="/bookNotes/assets/js/48.625d747e.js"><link rel="prefetch" href="/bookNotes/assets/js/49.f97abe71.js"><link rel="prefetch" href="/bookNotes/assets/js/5.dd4a8225.js"><link rel="prefetch" href="/bookNotes/assets/js/50.68dee525.js"><link rel="prefetch" href="/bookNotes/assets/js/51.583184a8.js"><link rel="prefetch" href="/bookNotes/assets/js/52.c7af0993.js"><link rel="prefetch" href="/bookNotes/assets/js/53.b647ed86.js"><link rel="prefetch" href="/bookNotes/assets/js/54.a5fbaa3d.js"><link rel="prefetch" href="/bookNotes/assets/js/55.a7b560d2.js"><link rel="prefetch" href="/bookNotes/assets/js/56.33015b4d.js"><link rel="prefetch" href="/bookNotes/assets/js/57.80ffe644.js"><link rel="prefetch" href="/bookNotes/assets/js/58.11a6edd1.js"><link rel="prefetch" href="/bookNotes/assets/js/59.e8bead8f.js"><link rel="prefetch" href="/bookNotes/assets/js/6.4505f2dd.js"><link rel="prefetch" href="/bookNotes/assets/js/60.cda1b788.js"><link rel="prefetch" href="/bookNotes/assets/js/61.16b57984.js"><link rel="prefetch" href="/bookNotes/assets/js/62.0476eb6a.js"><link rel="prefetch" href="/bookNotes/assets/js/63.f31d1faa.js"><link rel="prefetch" href="/bookNotes/assets/js/64.2e35d3be.js"><link rel="prefetch" href="/bookNotes/assets/js/65.e4ba2ad2.js"><link rel="prefetch" href="/bookNotes/assets/js/66.c2f247d4.js"><link rel="prefetch" href="/bookNotes/assets/js/67.393df1f2.js"><link rel="prefetch" href="/bookNotes/assets/js/68.875cabd4.js"><link rel="prefetch" href="/bookNotes/assets/js/69.54e25a4e.js"><link rel="prefetch" href="/bookNotes/assets/js/7.670f9f76.js"><link rel="prefetch" href="/bookNotes/assets/js/70.17e6d438.js"><link rel="prefetch" href="/bookNotes/assets/js/71.95131df7.js"><link rel="prefetch" href="/bookNotes/assets/js/72.83e3f4f8.js"><link rel="prefetch" href="/bookNotes/assets/js/74.13fba1a5.js"><link rel="prefetch" href="/bookNotes/assets/js/75.8ea1e0ca.js"><link rel="prefetch" href="/bookNotes/assets/js/76.1bd9ac71.js"><link rel="prefetch" href="/bookNotes/assets/js/77.470d01e4.js"><link rel="prefetch" href="/bookNotes/assets/js/78.29be0910.js"><link rel="prefetch" href="/bookNotes/assets/js/79.0da8502d.js"><link rel="prefetch" href="/bookNotes/assets/js/8.3c63f96d.js"><link rel="prefetch" href="/bookNotes/assets/js/80.f840286c.js"><link rel="prefetch" href="/bookNotes/assets/js/81.8dc38613.js"><link rel="prefetch" href="/bookNotes/assets/js/82.63f9f794.js"><link rel="prefetch" href="/bookNotes/assets/js/83.92125d6e.js"><link rel="prefetch" href="/bookNotes/assets/js/84.2dd13e00.js"><link rel="prefetch" href="/bookNotes/assets/js/85.90ac8d90.js"><link rel="prefetch" href="/bookNotes/assets/js/86.00a9730f.js"><link rel="prefetch" href="/bookNotes/assets/js/87.8a9e4f11.js"><link rel="prefetch" href="/bookNotes/assets/js/88.4b63d7ed.js"><link rel="prefetch" href="/bookNotes/assets/js/89.8cbf23b4.js"><link rel="prefetch" href="/bookNotes/assets/js/9.2033ddc1.js"><link rel="prefetch" href="/bookNotes/assets/js/90.871ef198.js"><link rel="prefetch" href="/bookNotes/assets/js/91.f87deae7.js"><link rel="prefetch" href="/bookNotes/assets/js/92.3eb8316d.js"><link rel="prefetch" href="/bookNotes/assets/js/93.ccc52aee.js"><link rel="prefetch" href="/bookNotes/assets/js/94.17ce85a1.js"><link rel="prefetch" href="/bookNotes/assets/js/95.490c860d.js"><link rel="prefetch" href="/bookNotes/assets/js/96.ed694272.js"><link rel="prefetch" href="/bookNotes/assets/js/97.e9cae244.js">
    <link rel="stylesheet" href="/bookNotes/assets/css/0.styles.02a9e5b3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bookNotes/" class="home-link router-link-active"><!----> <span class="site-name">👨🏽‍💻前端漫游指南</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/bookNotes/macosguide/" class="nav-link">MacOS配置</a></div><div class="nav-item"><a href="/bookNotes/weekstudy/" class="nav-link router-link-active">周学系列</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">学习系列</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bookNotes/cssmagic/" class="nav-link">CSS揭秘</a></li><li class="dropdown-item"><!----> <a href="/bookNotes/algorithm/" class="nav-link">前端数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/bookNotes/interview/" class="nav-link">面试知多少</a></li><li class="dropdown-item"><!----> <a href="/bookNotes/reactstatus/" class="nav-link">React状态管理与同构实战</a></li><li class="dropdown-item"><!----> <a href="/bookNotes/koa2/" class="nav-link">Koa2系列</a></li><li class="dropdown-item"><!----> <a href="/bookNotes/nodejs/" class="nav-link">Nodejs系列</a></li></ul></div></div><div class="nav-item"><a href="http://h5web.cc/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/MarioGogogo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MarioGogogo/react" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法仓库
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/bookNotes/macosguide/" class="nav-link">MacOS配置</a></div><div class="nav-item"><a href="/bookNotes/weekstudy/" class="nav-link router-link-active">周学系列</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">学习系列</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bookNotes/cssmagic/" class="nav-link">CSS揭秘</a></li><li class="dropdown-item"><!----> <a href="/bookNotes/algorithm/" class="nav-link">前端数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/bookNotes/interview/" class="nav-link">面试知多少</a></li><li class="dropdown-item"><!----> <a href="/bookNotes/reactstatus/" class="nav-link">React状态管理与同构实战</a></li><li class="dropdown-item"><!----> <a href="/bookNotes/koa2/" class="nav-link">Koa2系列</a></li><li class="dropdown-item"><!----> <a href="/bookNotes/nodejs/" class="nav-link">Nodejs系列</a></li></ul></div></div><div class="nav-item"><a href="http://h5web.cc/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/MarioGogogo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MarioGogogo/react" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法仓库
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/bookNotes/weekstudy/" class="sidebar-link">用好谷歌!!!(重点)</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2019年38周</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2019年39周</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2019年40周</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2019年41周</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2019年42周</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2019年43周</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2019年44周</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2019年45周</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2019年46周</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>2019年47周</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/bookNotes/weekstudy/React性能优化大挑战.html" class="active sidebar-link">React 性能优化大挑战</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bookNotes/weekstudy/React性能优化大挑战.html#第一题" class="sidebar-link">第一题</a></li><li class="sidebar-sub-header"><a href="/bookNotes/weekstudy/React性能优化大挑战.html#第二题" class="sidebar-link">第二题</a></li><li class="sidebar-sub-header"><a href="/bookNotes/weekstudy/React性能优化大挑战.html#第三题" class="sidebar-link">第三题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bookNotes/weekstudy/React性能优化大挑战.html#提升-react-效能：保持-virtual-dom-的一致" class="sidebar-link">提升 React 效能：保持 virtual DOM 的一致</a></li><li class="sidebar-sub-header"><a href="/bookNotes/weekstudy/React性能优化大挑战.html#提升-react-效能：不要觸發-render-function" class="sidebar-link">提升 React 效能：不要觸發 render function</a></li><li class="sidebar-sub-header"><a href="/bookNotes/weekstudy/React性能优化大挑战.html#shallowequal-與-immutable-data-structures" class="sidebar-link">shallowEqual 與 Immutable data structures</a></li><li class="sidebar-sub-header"><a href="/bookNotes/weekstudy/React性能优化大挑战.html#purecomponent-的陷阱" class="sidebar-link">PureComponent 的陷阱</a></li></ul></li><li class="sidebar-sub-header"><a href="/bookNotes/weekstudy/React性能优化大挑战.html#参考资料：" class="sidebar-link">参考资料：</a></li></ul></li><li><a href="/bookNotes/weekstudy/Redux vs Mobx之衍生属性.html" class="sidebar-link">Redux vs Mobx之衍生属性</a></li><li><a href="/bookNotes/weekstudy/前端路由原理解析和实现.html" class="sidebar-link">前端路由原理解析和实现</a></li><li><a href="/bookNotes/weekstudy/取消fetch多次请求取最后.html" class="sidebar-link">取消fetch多次请求取最后</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2019年48周</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2019年49周</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2019年51周</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2019年52周</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="react-性能优化大挑战"><a href="#react-性能优化大挑战" aria-hidden="true" class="header-anchor">#</a> React 性能优化大挑战</h1> <div class="tip custom-block"><p class="custom-block-title">提示</p> <p>原文地址 https://blog.techbridge.cc/2018/01/05/react-render-optimization/</p></div> <p>前阵子正在改造公司的专案，试了一些东西之后发现自己对于 React 的渲染机制其实不太了解，不太知道 render 什么时候会被触发。而后来我发现不只我这样，其实还有满多人对这整个机制不太熟悉，因此决定写这篇来分享自己的心得。</p> <p>其实不知道怎么优化倒还好，更惨的事情是你自以为在优化，其实却在拖慢效能，而根本的原因就是对 React 的整个机制还不够熟。被“优化”过的 component 反而还变慢了！这个就严重了。</p> <p>因此，这篇文章会涵盖到以下几个主题：</p> <ol><li>组件跟 PureComponent 的差异</li> <li>shouldComponentUpdate 的作用</li> <li>React 的渲染机制</li> <li>为什么要用</li></ol> <p>为了判别你到底对以上这些理解多少，我们马上进行几个小测验！有些有陷阱，请睁大眼睛看清楚啦！</p> <h2 id="第一题"><a href="#第一题" aria-hidden="true" class="header-anchor">#</a> <a href="#%E7%AC%AC%E4%B8%80%E9%A1%8C" title="第一题"></a>第一题</h2> <p>以下程式码是一个很简单的网页，就一个按钮跟一个叫做<code>Content</code>的元件而已，而按钮按下去之后会改变<code>App</code>这个 component 的状态。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Content</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;render content!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Content<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      a<span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;render App!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>setState<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Content <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>请问：当你点击按钮之后，console 会输出什么？</p> <p>A.什么都没有（App 跟 Content 的渲染功能都没被执行到）<br>
B.只有<code>render App!</code>（只有 App 的 render 功能被执行到）<br>
C. <code>render App!</code>以及<code>render content!</code>（其中的 render 功能都被执行到）</p> <h2 id="第二题"><a href="#第二题" aria-hidden="true" class="header-anchor">#</a> <a href="#%E7%AC%AC%E4%BA%8C%E9%A1%8C" title="第二题"></a>第二题</h2> <p>以下程序码也很简单，分为三个元素：App，Table 跟 Row，由 App 传递列表给 Table，Table 再用 map 把每一个 Row 都渲染出来。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Row</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> item<span class="token punctuation">,</span> style <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>tr style<span class="token operator">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Table</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">const</span> itemStyle <span class="token operator">=</span> <span class="token punctuation">{</span>
      color<span class="token punctuation">:</span> <span class="token string">&quot;red&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>table<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
          <span class="token operator">&lt;</span>Row key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span> item<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span>itemStyle<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    list<span class="token punctuation">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> index <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      otherState<span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>change state<span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Table list<span class="token operator">=</span><span class="token punctuation">{</span>list<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而这段程序码的问题就在于按下按钮之后，<code>App</code>的渲染功能被触发，然后<code>Table</code>的渲染功能也被触发，所以重新渲染了一次整个列表。</p> <p>可是呢，我们点击按钮之后，<code>list</code>根本没变，其实是不需要重新渲染的，所以聪明的小明把表从 Component 变成 PureComponent，只要状态跟 props 没变就不会重新渲染，变成下面这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Table</span> <span class="token keyword">extends</span> <span class="token class-name">PureComponent</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>list<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">const</span> itemStyle <span class="token operator">=</span> <span class="token punctuation">{</span>
      color<span class="token punctuation">:</span> <span class="token string">'red'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>table<span class="token operator">&gt;</span>
          <span class="token punctuation">{</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token operator">&lt;</span>Row key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span> item<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span>itemStyle<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 不知道什麼是 PureComponent 的朋友，可以想成他自己幫你加了下面的 function</span>
<span class="token function">shouldComponentUpdate</span> <span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">shallowEqual</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">shallowEqual</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>把 Table 从 Component 转换成 PureComponent 之后，如果我们再做一次同样的操作，也就是按下<code>change state</code>按钮改变 App 的状态，这时候会提升效率吗？</p> <p>A.会，在这情况下 PureComponent 会比 Component 有效率<br>
B。不会，两者差不多<br>
C. 不会，在这情况下组件会比 PureComponent 有效率</p> <h2 id="第三题"><a href="#第三题" aria-hidden="true" class="header-anchor">#</a> <a href="#%E7%AC%AC%E4%B8%89%E9%A1%8C" title="第三题"></a>第三题</h2> <p>接着让我来看一个跟随上一题很像的例子，只是这次换成按按钮以后会改变 list：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Row</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> item<span class="token punctuation">,</span> style <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>tr style<span class="token operator">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Table</span> <span class="token keyword">extends</span> <span class="token class-name">PureComponent</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">const</span> itemStyle <span class="token operator">=</span> <span class="token punctuation">{</span>
      color<span class="token punctuation">:</span> <span class="token string">&quot;red&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>table<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
          <span class="token operator">&lt;</span>Row key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span> item<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span>itemStyle<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    list<span class="token punctuation">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> index <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>this<span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">,</span> <span class="token number">1234567</span><span class="token punctuation">]</span> <span class="token comment">// 增加一個元素</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>change state<span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Table list<span class="token operator">=</span><span class="token punctuation">{</span>list<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这时候 Table 的 PureComponent 优化已经没有用了，因为列表已经变了，所以会触发 render 函数。要继续优化的话，比较常用的手段是把 Row 变成 PureComponent，这样就可以确保相同的 Row 不会再次渲染。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Row</span> <span class="token keyword">extends</span> <span class="token class-name">PureComponent</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> item<span class="token punctuation">,</span> style <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>tr style<span class="token operator">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Table</span> <span class="token keyword">extends</span> <span class="token class-name">PureComponent</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">const</span> itemStyle <span class="token operator">=</span> <span class="token punctuation">{</span>
      color<span class="token punctuation">:</span> <span class="token string">&quot;red&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>table<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
          <span class="token operator">&lt;</span>Row key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span> item<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span>itemStyle<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>请问：把行从组件转换成 PureComponent 之后，如果我们再做一次同样的操作，也就是点击<code>change state</code>按钮更改列表，这时候会提升效率吗？</p> <p>A.会，在这情况下 PureComponent 会比 Component 有效率<br>
B。不会，两者差不多<br>
C. 不会，在这情况下组件会比 PureComponent 有效率</p> <p>在公布答案之前，先帮大家简单复习一下 React 是如何把你的画面渲染出来的。</p> <p>首先，大家都知道你在<code>render</code>这个功能里面可以回传你想渲染的东西，例如说：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Content</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Content<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>要注意的是这边 return 的东西不会直接就放到 DOM 上去，而是会先通过一层 virtual DOM。其实你可以简单把这个 virtual DOM 想成 JavaScript 的物件，例如说上面的内容渲染出来的结果可能是：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  tagName<span class="token punctuation">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token string">'Content'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后一步则是 React 进行虚拟 DOM 差异，把上次的跟这次的做比较，并且把移动的部分更新到真的 DOM 上面去。</p> <p>简单来说呢，就是在 React Component 以及 DOM 之间另外添加了一个虚拟 DOM，先把你要渲染的东西转成虚拟 DOM，再把需要更新的东西 update 到真的 DOM 上面去。</p> <p>如此一来，就能够减少触碰到真的 DOM 的次数和提升性能。</p> <p>举个例子，假设我们实作一个非常简单的，按一个按钮之后就会改变 state 的小范例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Content</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    text<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      text<span class="token punctuation">:</span> <span class="token string">&quot;world&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>setState<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Content text<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>text<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在程式刚开始执行时，呈现的顺序是这样的：</p> <ol><li>呼叫 App 的 render</li> <li>呼叫内容的 render</li> <li>拿到虚拟 DOM</li> <li>跟上次的 virtual DOM 做比较</li> <li>把改变的地方应用到真的</li></ol> <p>这时候的虚拟 DOM 整体应该会长得像这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  tagName<span class="token punctuation">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      tagName<span class="token punctuation">:</span> <span class="token string">'button'</span><span class="token punctuation">,</span>
      children<span class="token punctuation">:</span> <span class="token string">'setState'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      tagName<span class="token punctuation">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
      children<span class="token punctuation">:</span> <span class="token string">'hello'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当你点击按钮，改变状态了以后，执行顺序都跟刚刚一样：</p> <ol><li>呼叫 App 的 render</li> <li>呼叫内容的 render</li> <li>拿到虚拟 DOM</li></ol> <p>这时候拿到的 virtual DOM 应该会长得像这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  tagName<span class="token punctuation">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      tagName<span class="token punctuation">:</span> <span class="token string">'button'</span><span class="token punctuation">,</span>
      children<span class="token punctuation">:</span> <span class="token string">'setState'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      tagName<span class="token punctuation">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
      children<span class="token punctuation">:</span> <span class="token string">'world'</span> <span class="token comment">// 只有這邊變了</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而 React 的虚拟 DOM 差异演算法，就会发现只有一个地方改变，然后把那边的文字替换掉，其他部分都不会动到。</p> <p>其实<a href="https://reactjs.org/docs/reconciliation.html#motivation" target="_blank" rel="noopener noreferrer">官方文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>把这一段写得很好：</p> <blockquote><p>使用 React 时，您可以在单个时间点将 render（）函数视为创建 React 元素树。在下一个状态或道具更新时，该 render（）函数将返回不同的 React 元素树。然后，React 需要弄清楚如何有效地更新 UI 以匹配最新的树。</p></blockquote> <p>大意就是你可以想像成 render 函数会回传一个 React elements 的 tree，然后 React 会把这次的 tree 跟上次的做比较，并且发现如何有效率地把这差异 update 到 UI 上面去。</p> <p>所以说呢，如果你要成功更新画面，你必须经过两个步骤：</p> <ol><li>渲染功能</li> <li>虚拟 DOM 差异</li></ol> <p>因此，要优化效能的话你有两个方向，那就是：</p> <ol><li>不要触发渲染功能</li> <li>保持虚拟 DOM 的一致</li></ol> <p>我们先从另外开始吧！</p> <h3 id="提升-react-效能：保持-virtual-dom-的一致"><a href="#提升-react-效能：保持-virtual-dom-的一致" aria-hidden="true" class="header-anchor">#</a> 提升 React 效能：保持 virtual DOM 的一致</h3> <p>因为有了 virtual DOM 这一层的守护，通常你不必太担心 React 的效能。</p> <p>像是我们开头问答的第一题：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Content</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;render content!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Content<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      a<span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;render App!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>setState<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Content <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>您每次按下按钮之后，由于 App 的状态改变了，所以会先触发 App 的呈现功能，而因为里面有回传<code>&lt;Content /&gt;</code>，所以也会触发 Content 的呈现功能。</p> <p>因此你每按一次按钮，这两个组件的 render function 就会个别被呼叫一次。所以答案是<code>C. render App! 以及 render content!（兩者的 render function 都被執行到）</code></p> <p>因为是虚拟如此，真的 DOM 不会有任何变化。因为在 virtual DOM diff 的时候，反应会发现你这次跟上次的 virtual DOM 长得一模一样（因为没有东西改变嘛），就不会对 DOM 做任何操作。</p> <p>如果能维持维持 virtual DOM 的结构相似的话，可以减少一些额外的操作，在这点上其实可以做的优化还很多，可以参考<a href="https://reactjs.org/docs/reconciliation.html" target="_blank" rel="noopener noreferrer">官方文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，里面写的很详细。</p> <h3 id="提升-react-效能：不要觸發-render-function"><a href="#提升-react-效能：不要觸發-render-function" aria-hidden="true" class="header-anchor">#</a> 提升 React 效能：不要觸發 render function</h3> <p>虽然不必太过担心，但是虚拟 DOM 差异也是需要执行时间的。虽然说速度很快，但再快也比不上完全不呼叫来的快，你说是吧。</p> <p>对于这种「我们已经明确知道不该有变化」的事实，我们连渲染都不该呼叫，因为没必要嘛，再怎么调用都是一样的结果。如果 render 没有被呼叫的话，连 virtual DOM diff 都不需要执行，又提升了一些性能。</p> <p>应该你听过有<code>shouldComponentUpdate</code>这个功能，就是来做这件事的。如果你在这个函数中回传假，就不会重新呼叫渲染功能。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Content</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;render content!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Content<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      a<span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;render App!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>setState<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Content <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>加上去之后，你会发现无论你按多次按钮，Content 的呈现功能都不会被触发。</p> <p>但是这个东西请小心使用，一个不注意你将会碰到 state 跟 UI 搭不上的样子，例如说 state 明明变成世界，可是 UI 显示的还是 Hello：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Content</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    text<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      text<span class="token punctuation">:</span> <span class="token string">&quot;world&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>setState<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Content text<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>text<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的示例中，点击按钮之后状态确实变为<code>world</code>，但是因为内容的<code>shouldComponentUpdate</code>永远都回传 false，所以不会再次触发 render，就看不到对应的新的状态的画面了。</p> <p>不过这有点极端，因为通常永远永远都回传 false，除非你真的确定这个 component 完全不需要 re-render。</p> <p>比起这个，有一个更合理的判断基准是：</p> <blockquote><p>如果每一个道具跟状态都没有变，那就回传 false</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Content</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">shallowEqual</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">shallowEqual</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>假设<code>this.props</code>是：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  text<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而<code>nextProps</code>的英文：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  text<span class="token punctuation">:</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在那比较的时候就会发现<code>props.text</code>变了，就可以顺理成章的呼叫渲染功能。另外还有一点一的英文这边用<code>shallowEqual</code>来比较前后的差异，而不是用<code>deepEqual</code>。</p> <p>这是出于效能上的考量。别忘了，你要执行这样的比较也是会吃资源的，尤其是在你的对象很深很深的时候，要比较的东西可就多了，因此我们会倾向用<code>shallowEqual</code>，只要比较一层即可。</p> <p>另外，前面有提到<code>PureComponent</code>这个东西，其实就是 React 提供的另外一种元件，区别就是在于它自动帮你加上上面那一段的比较。如果你想看原始码的话，<a href="https://github.com/facebook/react/blob/1637b43e27c40c73f9489603145f9bb1d0ece618/packages/react-reconciler/src/ReactFiberClassComponent.js#L194" target="_blank" rel="noopener noreferrer">在这边<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span>prototype <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isPureReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">shallowEqual</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">shallowEqual</span><span class="token punctuation">(</span>oldState<span class="token punctuation">,</span> newState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>讲到这边，就可以来发表第二题的解答了，答案是：<code>A. 會，在這情況下 PureComponent 會比 Component 有效率</code>，因为继承了 PureComponent 之后，只要道具跟状态没变，就不会执行 render 函数，也不会执行 virtual DOM diff，节省了许多开支。</p> <h3 id="shallowequal-與-immutable-data-structures"><a href="#shallowequal-與-immutable-data-structures" aria-hidden="true" class="header-anchor">#</a> shallowEqual 與 Immutable data structures</h3> <p>你刚开始在学 React 的时候，可能会被告诫说如果要更改资料，不能够这样写：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 不能這樣</span>
<span class="token keyword">const</span> newObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
newObject<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  obj<span class="token punctuation">:</span> newObject
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 也不能這樣</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>arr<span class="token punctuation">;</span>
arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  list<span class="token punctuation">:</span> arr
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>甚至应该要这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  obj<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>this<span class="token punctuation">.</span>state<span class="token punctuation">.</span>obj<span class="token punctuation">,</span>
    id<span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>this<span class="token punctuation">.</span>state<span class="token punctuation">.</span>arr<span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>但你知道为什么吗？</p> <p>上面所述，实际上使用<code>PureComponent</code>是一件很正常的事情，因为状态跟 props 如果没变的话，本来就不该触发渲染功能。</p> <p>而刚刚也提过<code>PureComponent</code>会帮你<code>shallowEqual</code>state 跟 props，決定要不要呼叫 render function。
在这种情况下，如果你用一开始讲的那种写法，就会产生问题，例如说：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> newObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
newObject<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  obj<span class="token punctuation">:</span> newObject
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在上面的程序码中，实际上<code>this.state.obj</code>跟<code>newObject</code>还是指向同一个物件，指向相同块记忆体，所以当我们在做<code>shallowEqual</code>的时候，就会判断出这两个东西是替代的，就不会执行 render function 了。</p> <p>在这时候，我们就需要不可变的数据，不可变翻成中文就是永远不变的，意思是：“当一个资料被创建之后，就永远不会变了”。那如果我需要更改资料的话怎么办呢？你就只能创一个新的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  text<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

obj<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 這樣不行，因為你改變了 obj 這個物件</span>

<span class="token comment">// 你必須要像這樣創造一個新的物件</span>
<span class="token keyword">const</span> newObj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>obj<span class="token punctuation">,</span>
  text<span class="token punctuation">:</span> <span class="token string">&quot;world&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>有了 Immutable 的概念之后，<code>shallowEqual</code>就不会出错了，因为如果我们有新的资料，就可以保证它是一个新的 object，这也是为什么我们在用<code>setState</code>的时候总是要产生一个新的物件，而不是直接对现有的做操作。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 沒有 Immutable 的概念前</span>
<span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">{</span>
  id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> list <span class="token operator">=</span> props<span class="token punctuation">.</span>list<span class="token punctuation">;</span>
list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
nextProps <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>props<span class="token punctuation">,</span>
  list
<span class="token punctuation">}</span><span class="token punctuation">;</span>

props<span class="token punctuation">.</span>list <span class="token operator">===</span> nextProps<span class="token punctuation">.</span>list<span class="token punctuation">;</span> <span class="token comment">// true</span>

<span class="token comment">// 有了 Immutable 的概念後</span>
<span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">{</span>
  id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> nextProps <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>props<span class="token punctuation">,</span>
  list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>props<span class="token punctuation">.</span>list<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

props<span class="token punctuation">.</span>list <span class="token operator">===</span> nextProps<span class="token punctuation">.</span>list<span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre></div><p>这边还有一个要注意的地方，那就是传播算子只是复制第一层的资料而已，它并不深克隆：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> test <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  nest<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> copy <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>test <span class="token punctuation">}</span><span class="token punctuation">;</span>

copy<span class="token punctuation">.</span>nest <span class="token operator">===</span> test<span class="token punctuation">.</span>nest<span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre></div><p>所以当你的状态是比较复杂的结构时，要改变资料就会变得变得比较麻烦一点，因为你必须要对每一层都做差不多的事情，避免直接去改到你要改的物体：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 沒有 Immutable 的概念前</span>
<span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">{</span>
  title<span class="token punctuation">:</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span>
  list<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">&quot;world&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> list <span class="token operator">=</span> props<span class="token punctuation">.</span>list<span class="token punctuation">;</span>
list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;world2&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 直接改</span>
nextProps <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>props<span class="token punctuation">,</span>
  list
<span class="token punctuation">}</span><span class="token punctuation">;</span>

props<span class="token punctuation">.</span>list <span class="token operator">===</span> nextProps<span class="token punctuation">.</span>list<span class="token punctuation">;</span> <span class="token comment">// true</span>
props<span class="token punctuation">.</span>list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> nextProps<span class="token punctuation">.</span>list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

<span class="token comment">// 有了 Immutable 的概念後</span>
<span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">{</span>
  title<span class="token punctuation">:</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span>
  list<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">&quot;world&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 要注意這邊只是 shallow copy 而已</span>
<span class="token comment">// list[0] === props.list[0] =&gt; true</span>
<span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>props<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> props<span class="token punctuation">.</span>list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> nextProps <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>props<span class="token punctuation">,</span>
  list<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token operator">...</span>list<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token operator">...</span>data<span class="token punctuation">,</span> <span class="token comment">// 再做一次 spread oprator</span>
      name<span class="token punctuation">:</span> <span class="token string">&quot;world2&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

props<span class="token punctuation">.</span>list <span class="token operator">===</span> nextProps<span class="token punctuation">.</span>list<span class="token punctuation">;</span> <span class="token comment">// false</span>
props<span class="token punctuation">.</span>list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> nextProps<span class="token punctuation">.</span>list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
props<span class="token punctuation">.</span>list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> nextProps<span class="token punctuation">.</span>list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre></div><p>若你的状态结构很多层，那就会变得非常非常难改，这时候你有三个选择：</p> <ol><li>避免太多多层的状态，尽量压平（可参考<a href="https://github.com/paularmstrong/normalizr" target="_blank" rel="noopener noreferrer">normalizr<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</li> <li>找一个会帮你做不可变的库，例如说 Facebook 的<a href="https://facebook.github.io/immutable-js/" target="_blank" rel="noopener noreferrer">Immutable.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>直接用 deep clone 把资料全部复制下来，之后你爱怎么改就怎么改（不推荐）</li></ol> <p>注：感谢网友 KanYueh Chen 的指正，让我补上上面这一段。</p> <h3 id="purecomponent-的陷阱"><a href="#purecomponent-的陷阱" aria-hidden="true" class="header-anchor">#</a> PureComponent 的陷阱</h3> <p>当我们遵守 Immutable 的规则之后，理所当然的就会想把所有的 Component 都设成。</p> <p>那让我们回头来看开场小测验的最后一题：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Row</span> <span class="token keyword">extends</span> <span class="token class-name">PureComponent</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> item<span class="token punctuation">,</span> style <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>tr style<span class="token operator">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Table</span> <span class="token keyword">extends</span> <span class="token class-name">PureComponent</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">const</span> itemStyle <span class="token operator">=</span> <span class="token punctuation">{</span>
      color<span class="token punctuation">:</span> <span class="token string">&quot;red&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>table<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
          <span class="token operator">&lt;</span>Row key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span> item<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span>itemStyle<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们把<code>Row</code>变成了 PureComponent，所以只要状态跟 props 没变，就不会 re-render，所以答案应该要是<code>A. 會，在這情況下 PureComponent 會比 Component 有效率</code>？</p> <p>错，如果你把程式码看更清楚一点，你会发现答案其实是<code>C. 不會，在這情況下 Component 會比 PureComponent 有效率</code>。</p> <p>你的正确是对的，“只要状态跟 props 没变，就不会重新渲染，PureComponent 就会比 Component 效率”。但实际上还有另外一句话也是对的：“如果你的 state 或 props 『永远都会变』，那 PureComponent 并不会比较快」。</p> <p>所以这两种的使用时机差异在于：state 跟 props 到底常常会变还是不会变？</p> <p>上述的示例中，陷阱在于<code>itemStyle</code>这个 props，我们每次 render 的时候都创造了一个新的物件，所以对 Row 来说，尽管 props.item 是一样的，但是 props.style 却是“每次都不一样”。</p> <p>如果你已经知道每次都会不一样，那 PureComponent 这时候就无用武之地了，而且还更糟。为什么？因为它帮你做了<code>shallowEqual</code>。</p> <p>别忘记了，也是<code>shallowEqual</code>需要执行时间的。</p> <p>已经知道 props 的比较每次都失败的话，那不如不要比即将来到的比较快，所以在这个有意义下，Component 会比 PureComponent 有效率，因为不用做<code>shallowEqual</code>。</p> <p>这就是我开头提到的需要特别注意的部分。不要以为你把每个 Component 都换成 PureComponent 就天下太平，App 变超快，性能提升好几倍。不去注意这些细节的话，就有可能把效能越弄越糟。</p> <p>最后再精选一次，如果你已经预期到某个 component 的道具或者状态会“很容易变动”，那你根本不用换成 PureComponent，因为你实作之后反而会变得更慢。</p> <p>在研究这些性能相关的问题时，我最推荐的内容：<a href="https://cdb.reacttraining.com/react-inline-functions-and-performance-bdff784f5578" target="_blank" rel="noopener noreferrer">反应，内联函数和性能<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，解开了很多我心中的疑惑以及带给我很多新的想法。</p> <p>例如说文末提到的 PureComponent 有时候反而会变慢，也是从这篇文章看来的，真心推荐大家抽空去看看。</p> <p>前阵子跟同事一起把一个专案打掉重做，原本的共识是尝试用 PureComponent，直到我看到介绍文并仔细思考了一下，发现如果你不知道背后的原理，还是不要轻易使用比较好。因此我就有望改成全部用组件，等我们碰到效能问题要来优化时再慢慢调整。</p> <p>最后附上一句我很喜欢的话，从<a href="https://blog.wuct.me/react-%E5%B7%A2%E7%8B%80-component-%E6%95%88%E8%83%BD%E5%84%AA%E5%8C%96-b01d8a0d3eff" target="_blank" rel="noopener noreferrer">反应巢状 Component 效能优化提出<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>看来的（此处也是在讲最后提到的 PureComponent 的问题）：</p> <blockquote><p>虽然你知道可以优化，但不代表你应该优化。</p></blockquote> <p><img src="http://book.52react.cn/20191118122854.png" alt></p> <h2 id="参考资料："><a href="#参考资料：" aria-hidden="true" class="header-anchor">#</a> 参考资料：</h2> <p><a href="https://medium.freecodecamp.org/make-react-fast-again-tools-and-techniques-for-speeding-up-your-react-app-7ad39d3c1b82" target="_blank" rel="noopener noreferrer">高性能 React：3 个加速应用程序的新工具<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br> <a href="https://reactjs.org/docs/reconciliation.html#motivation" target="_blank" rel="noopener noreferrer">reactjs-对帐<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br> <a href="https://reactjs.org/docs/optimizing-performance.html" target="_blank" rel="noopener noreferrer">reactjs-优化性能<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br> <a href="https://marmelab.com/blog/2017/02/06/react-is-slow-react-is-fast.html" target="_blank" rel="noopener noreferrer">React 运行缓慢，React 快速：在实践中优化 React Apps<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br> <a href="https://www.toptal.com/react/optimizing-react-performance" target="_blank" rel="noopener noreferrer">高效的 React 组件：优化 React 性能的指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/bookNotes/assets/js/app.a5c1f5ee.js" defer></script><script src="/bookNotes/assets/js/73.2a333618.js" defer></script>
  </body>
</html>
